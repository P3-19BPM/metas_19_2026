<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de GestÃ£o Operacional - 19Âº BPM</title>
    
    <link rel="icon" type="image/x-icon" href="./imagens/Icones_logo_19bpm/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="./imagens/Icones_logo_19bpm/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./imagens/Icones_logo_19bpm/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="./imagens/Icones_logo_19bpm/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./imagens/Icones_logo_19bpm/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./imagens/Icones_logo_19bpm/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./imagens/Icones_logo_19bpm/android-chrome-512x512.png">
    <meta name="msapplication-TileImage" content="./imagens/Icones_logo_19bpm/mstile-150x150.png">
    <meta name="theme-color" content="#000000">
        <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Alpine.js (Deferido) -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pmmg: { gold: '#B3A369', goldLight: '#D4C9A0', red: '#AB2328', black: '#000000', gray: '#373435', bg: '#F3F4F6' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appData', () => ({
                // --- ESTADO ---
                currentMeta: 'meta_imv',
                mesesSelecionados: ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'],
                mesesLista: [
                    {id: 'jan', label: 'Jan'}, {id: 'fev', label: 'Fev'}, {id: 'mar', label: 'Mar'},
                    {id: 'abr', label: 'Abr'}, {id: 'mai', label: 'Mai'}, {id: 'jun', label: 'Jun'},
                    {id: 'jul', label: 'Jul'}, {id: 'ago', label: 'Ago'}, {id: 'set', label: 'Set'},
                    {id: 'out', label: 'Out'}, {id: 'nov', label: 'Nov'}, {id: 'dez', label: 'Dez'}
                ],
                filtroUnidade: 'todas',
                loading: false,
                erroCarregamento: null,
                expandedUnidades: [], 
                expandedPelotoes: [], 
                
                // --- CONFIGURAÃ‡ÃƒO DAS METAS ---
                // Agora apontam para a pasta local ./data/ que estÃ¡ dentro da imagem
                metasDisponiveis: [
                    { id: 'meta_imv', nome: 'Mortes Violentas (IMV)', icon: 'fa-solid fa-person-falling-burst', arquivo: './data/arquivo_joson_meta_imv_subsetor.json', grupo: 'resultado_gdo' },
                    { id: 'meta_icvpe', nome: 'Crimes Violentos Pessoa (ICVPe)', icon: 'fa-solid fa-mask', arquivo: './data/arquivo_joson_meta_icvpe_subsetor.json', grupo: 'resultado_gdo' },
                    { id: 'meta_icvpa', nome: 'Crimes Violentos PatrimÃ´nio (ICVPa)', icon: 'fa-solid fa-gun', arquivo: './data/arquivo_joson_meta_icvpa_subsetor.json', grupo: 'resultado_gdo' },
                    { id: 'meta_irtd', nome: 'TrÃ¡fico de Drogas (IRTD)', icon: 'fa-solid fa-cannabis', arquivo: './data/arquivo_joson_meta_irtd_subsetor.json', grupo: 'plano_acao' },
                    { id: 'meta_ppag', nome: 'Metas PPAG', icon: 'fa-solid fa-chart-line', arquivo: './data/metas_ppag.json', grupo: 'plano_proximidade' }
                ],

                dadosBase: { 'meta_imv': [], 'meta_icvpe': [], 'meta_icvpa': [], 'meta_irtd': [], 'meta_ppag': [] },
                dadosPLR_Processed: {},
                metasIRTDDetalhadas: { unidade: {}, pelotao: {}, setor: {} },
                ppagData: { municipios: [], cias: [], pelotoes: [] },
                ppagNivel: 'PELOTAO',
                ppagOperacaoFiltro: 'TODAS',
                ppagBusca: '',
                ppagTotais: { MUNICIPIO: 0, PELOTAO: 0, CIA_PM: 0 },
                ppagTotalAtual: 0,
                ppagTabela: [],
                ppagInfoOpen: false,

                // --- INICIALIZAÃ‡ÃƒO ---
                async init() {
                    console.log("ðŸš€ Iniciando Painel PMMG v5...");
                    try {
                        await this.carregarArquivoPLR();
                        await this.carregarDadosLocalmente('meta_imv');
                    } catch (e) {
                        console.error("Erro fatal na inicializaÃ§Ã£o:", e);
                        this.erroCarregamento = "Erro crÃ­tico ao iniciar aplicaÃ§Ã£o: " + e.message;
                    }
                },

                // --- CARREGAMENTO PLR ---
                async carregarArquivoPLR() {
                    try {
                        console.log("ðŸ“‚ Carregando PLR...");
                        const response = await fetch('./data/metas_plr.json');
                        
                        if (!response.ok) {
                            // Se nÃ£o achar o arquivo, apenas avisa e continua sem PLR
                            console.warn("âš ï¸ Aviso: metas_plr.json nÃ£o encontrado na pasta data.");
                            return; 
                        }
                        
                        let rawText = await response.text();
                        // Limpeza de seguranÃ§a (vÃ­rgulas e comentÃ¡rios)
                        rawText = rawText.replace(/\/\/.*$/gm, ""); 
                        rawText = rawText.replace(/:\s*(\d+),(\d+)/g, ': $1.$2'); 

                        const json = JSON.parse(rawText);
                        
                        for (const [metaKey, dados] of Object.entries(json)) {
                            this.dadosPLR_Processed[metaKey] = this.processarListaPLR(dados);
                        }
                        console.log("âœ… PLR Carregada.");
                    } catch (e) {
                        console.warn("âš ï¸ Erro ao processar PLR:", e);
                    }
                },

                processarListaPLR(lista) {
                    const mapa = {};
                    if (!Array.isArray(lista)) return mapa;
                    lista.forEach(row => {
                        if (row["CIA"] === "CIA") return;
                        let id = String(row["CIA"]);
                        // Normaliza ID (adiciona ponto se faltar, ex: 19155 -> 19.155)
                        if (id.length === 5 && !id.includes('.')) {
                            id = id.substring(0, 2) + '.' + id.substring(2);
                        }
                        mapa[id] = {
                            jan: row["JAN"], fev: row["FEV"], mar: row["MAR"], abr: row["ABR"], mai: row["MAI"], jun: row["JUN"],
                            jul: row["JUL"], ago: row["AGO"], set: row["SET"], out: row["OUT"], nov: row["NOV"], dez: row["DEZ"]
                        };
                    });
                    return mapa;
                },

                // --- CARREGAMENTO DADOS ---
                async carregarDadosLocalmente(metaId) {
                    const metaInfo = this.metasDisponiveis.find(m => m.id === metaId);
                    if (!metaInfo || !metaInfo.arquivo) return;
                    if (metaId === 'meta_ppag' && (this.ppagData.pelotoes || []).length > 0) { this.processarPPAG(); return; }
                    if (metaId !== 'meta_ppag' && this.dadosBase[metaId].length > 0) return; 

                    this.loading = true;
                    this.erroCarregamento = null;

                    try {
                        console.log(`ðŸ“‚ Carregando dados: ${metaId}`);
                        const response = await fetch(metaInfo.arquivo);
                        
                        if (!response.ok) {
                            throw new Error(`Arquivo nÃ£o encontrado: ${metaInfo.arquivo}`);
                        }
                        
                        let rawText = await response.text();
                        rawText = rawText.replace(/\/\/.*$/gm, "");
                        rawText = rawText.replace(/:\s*(\d+),(\d+)/g, ': $1.$2');

                        const jsonData = JSON.parse(rawText);
                        const dadosProcessados = metaId === 'meta_irtd'
                            ? this.construirEstruturaIRTD(jsonData)
                            : (metaId === 'meta_ppag' ? [] : jsonData);

                        this.dadosBase[metaId] = dadosProcessados;

                        if (metaId === 'meta_irtd') {
                            this.dadosPLR_Processed.meta_irtd = this.processarMetasIRTD(jsonData);
                        }

                        if (metaId === 'meta_ppag') {
                            this.ppagData = this.normalizarPPAG(jsonData);
                            this.processarPPAG();
                        }

                        if (metaId !== 'meta_ppag' && dadosProcessados.length > 0 && this.expandedUnidades.length === 0) {
                            this.expandedUnidades.push(dadosProcessados[0].id);
                        }
                        console.log("âœ… Dados carregados com sucesso.");

                    } catch (error) {
                        console.error("Erro:", error);
                        this.erroCarregamento = error.message;
                    } finally {
                        this.loading = false;
                    }
                },

                // --- INTERFACE ---
                toggleMes(mesId) {
                    if (this.mesesSelecionados.includes(mesId)) this.mesesSelecionados = this.mesesSelecionados.filter(m => m !== mesId);
                    else this.mesesSelecionados.push(mesId);
                    if (this.currentMeta === 'meta_ppag') this.processarPPAG();
                },
                selecionarTodosMeses() { this.mesesSelecionados = this.mesesLista.map(m => m.id); if (this.currentMeta === 'meta_ppag') this.processarPPAG(); },
                limparMeses() { this.mesesSelecionados = []; if (this.currentMeta === 'meta_ppag') this.processarPPAG(); },
                getLabelMeses() {
                    if (this.mesesSelecionados.length === 12) return 'Ano Completo (12)';
                    if (this.mesesSelecionados.length === 0) return 'Selecione...';
                    if (this.mesesSelecionados.length <= 2) return this.mesesSelecionados.map(m => m.toUpperCase()).join(', ');
                    return `${this.mesesSelecionados.length} meses`;
                },

                // --- CÃLCULOS ---
                getValorAcumulado(dadosObjeto) {
                    if (!dadosObjeto) return 0;
                    return this.mesesSelecionados.reduce((acc, mes) => {
                        const val = dadosObjeto[mes] || dadosObjeto[mes.toUpperCase()] || 0;
                        return acc + val;
                    }, 0);
                },

                normalizarId(id) {
                    if (id === undefined || id === null) return '';
                    const idStr = String(id).trim();
                    if (idStr.length === 5 && !idStr.includes('.')) return idStr.substring(0, 2) + '.' + idStr.substring(2);
                    return idStr;
                },

                gerarDadosZerados() {
                    return { pop: 0, jan: 0, fev: 0, mar: 0, abr: 0, mai: 0, jun: 0, jul: 0, ago: 0, set: 0, out: 0, nov: 0, dez: 0 };
                },

                distribuirMetaMensal(metaAnual) {
                    const anual = parseFloat(metaAnual) || 0;
                    const mensal = anual / 12;
                    return { jan: mensal, fev: mensal, mar: mensal, abr: mensal, mai: mensal, jun: mensal, jul: mensal, ago: mensal, set: mensal, out: mensal, nov: mensal, dez: mensal, anual };
                },
                processarMetasIRTD(jsonData) {
                    const mapaMetasUnidade = {};
                    const detalhes = { unidade: {}, pelotao: {}, setor: {} };
                    const unidades = Array.isArray(jsonData?.unidades) ? jsonData.unidades : [];
                    const territoriais = unidades.find(u => u.tipo === 'territorial');
                    const locais = Array.isArray(territoriais?.locais) ? territoriais.locais : [];

                    const locaisPorPelotao = {};
                    locais.forEach(local => {
                        const localId = this.normalizarId(local.id);
                        const pelotaoId = localId.split('.').slice(0, 3).join('.');
                        if (!locaisPorPelotao[pelotaoId]) locaisPorPelotao[pelotaoId] = [];
                        locaisPorPelotao[pelotaoId].push({
                            id: localId,
                            nome: local.nome,
                            metaAnual: parseFloat(local.meta_anual) || 0
                        });
                    });

                    unidades.forEach(unidade => {
                        if (unidade.tipo === 'territorial' || unidade.id === '19.000') return;

                        const unidadeId = this.normalizarId(unidade.id);
                        let metaUnidade = 0;

                        if (Array.isArray(unidade.pelotoes) && unidade.pelotoes.length > 0) {
                            unidade.pelotoes.forEach(pelotao => {
                                const pelotaoId = this.normalizarId(pelotao.id);
                                const metaPelotaoBase = parseFloat(pelotao.meta_anual) || 0;
                                const locaisDoPelotao = locaisPorPelotao[pelotaoId] || [];

                                if (locaisDoPelotao.length > 0) {
                                    const somaSubsetores = locaisDoPelotao.reduce((acc, item) => acc + item.metaAnual, 0);
                                    detalhes.pelotao[pelotaoId] = somaSubsetores;
                                    locaisDoPelotao.forEach(item => {
                                        detalhes.setor[item.id] = item.metaAnual;
                                    });
                                    metaUnidade += somaSubsetores;
                                } else {
                                    detalhes.pelotao[pelotaoId] = metaPelotaoBase;
                                    detalhes.setor[`${pelotaoId}.0`] = metaPelotaoBase;
                                    metaUnidade += metaPelotaoBase;
                                }
                            });
                        } else {
                            metaUnidade = parseFloat(unidade.meta_anual) || 0;
                            detalhes.pelotao[`${unidadeId}.1`] = metaUnidade;
                            detalhes.setor[`${unidadeId}.1.1`] = metaUnidade;
                        }

                        detalhes.unidade[unidadeId] = metaUnidade;
                        mapaMetasUnidade[unidadeId] = { anual: metaUnidade };
                    });

                    this.metasIRTDDetalhadas = detalhes;
                    return mapaMetasUnidade;
                },

                getMetaIRTDUnidade(unidadeId) {
                    const id = this.normalizarId(unidadeId);
                    return this.metasIRTDDetalhadas?.unidade?.[id] || 0;
                },

                getMetaIRTDPelotao(pelotaoId) {
                    const id = this.normalizarId(pelotaoId);
                    return this.metasIRTDDetalhadas?.pelotao?.[id] || 0;
                },

                getMetaIRTDSetor(setorId) {
                    const id = this.normalizarId(setorId);
                    return this.metasIRTDDetalhadas?.setor?.[id] || 0;
                },

                temMeta() {
                    return this.currentMeta === 'meta_irtd' || this.currentMeta === 'meta_ppag' || this.temPLR();
                },

                getMetaLabel() {
                    if (this.currentMeta === 'meta_irtd') return 'Meta (Anual)';
                    if (this.currentMeta === 'meta_ppag') return 'Total PPAG';
                    return 'Meta (PLR)';
                },

                getMetaUnidade(unidadeId) {
                    if (this.currentMeta === 'meta_irtd') return this.getMetaIRTDUnidade(unidadeId);
                    if (this.currentMeta === 'meta_ppag') return 0;
                    return this.getValorPLR(unidadeId);
                },

                getMetaBPM() {
                    if (this.currentMeta === 'meta_irtd') {
                        const unidades = this.dadosBase[this.currentMeta] || [];
                        return unidades.reduce((acc, unidade) => acc + this.getMetaIRTDUnidade(unidade.id), 0);
                    }
                    if (this.currentMeta === 'meta_ppag') return this.ppagTotalAtual || 0;
                    return this.getTotaisBPM().metaPLR;
                },

                construirEstruturaIRTD(jsonData) {

                    const unidades = Array.isArray(jsonData?.unidades) ? jsonData.unidades : [];
                    const territoriais = unidades.find(u => u.tipo === 'territorial');
                    const locais = Array.isArray(territoriais?.locais) ? territoriais.locais : [];

                    const locaisPorPelotao = {};
                    locais.forEach(local => {
                        const localId = this.normalizarId(local.id);
                        const pelotaoId = localId.split('.').slice(0, 3).join('.');
                        if (!locaisPorPelotao[pelotaoId]) locaisPorPelotao[pelotaoId] = [];
                        locaisPorPelotao[pelotaoId].push(local);
                    });

                    const unidadesOperacionais = unidades.filter(unidade => unidade.tipo !== 'territorial' && unidade.id !== '19.000');

                    return unidadesOperacionais.map(unidade => {
                        const unidadeId = this.normalizarId(unidade.id);

                        if (Array.isArray(unidade.pelotoes) && unidade.pelotoes.length > 0) {
                            const pelotoes = unidade.pelotoes.map(pelotao => {
                                const pelotaoId = this.normalizarId(pelotao.id);
                                const locaisDoPelotao = locaisPorPelotao[pelotaoId] || [];
                                const setores = locaisDoPelotao.length > 0
                                    ? locaisDoPelotao.map(local => ({ local: local.nome, id: this.normalizarId(local.id), dados: this.gerarDadosZerados() }))
                                    : [{ local: 'Sem subsetor definido', id: `${pelotaoId}.0`, dados: this.gerarDadosZerados() }];

                                return { nome: pelotao.nome, id: pelotaoId, setores };
                            });

                            return { unidade: unidade.unidade, id: unidadeId, pelotoes };
                        }

                        return {
                            unidade: unidade.unidade,
                            id: unidadeId,
                            pelotoes: [{
                                nome: `TM ${unidade.unidade}`,
                                id: `${unidadeId}.1`,
                                setores: [{ local: unidade.unidade, id: `${unidadeId}.1.1`, dados: this.gerarDadosZerados() }]
                            }]
                        };
                    });
                },


                normalizarPPAG(jsonData) {
                    return {
                        municipios: Array.isArray(jsonData?.municipios) ? jsonData.municipios : [],
                        cias: Array.isArray(jsonData?.cias) ? jsonData.cias : [],
                        pelotoes: Array.isArray(jsonData?.pelotoes) ? jsonData.pelotoes : []
                    };
                },

                getPPAGMesesAtivos() {
                    const mapa = { jan: 'JAN', fev: 'FEV', mar: 'MAR', abr: 'ABR', mai: 'MAI', jun: 'JUN', jul: 'JUL', ago: 'AGO', set: 'SET', out: 'OUT', nov: 'NOV', dez: 'DEZ' };
                    return this.mesesSelecionados.map(m => mapa[m]).filter(Boolean);
                },

                getPPAGChaveColecao() {
                    if (this.ppagNivel === 'MUNICIPIO') return 'municipios';
                    if (this.ppagNivel === 'CIA_PM') return 'cias';
                    return 'pelotoes';
                },

                getPPAGOperacoesDisponiveis() {
                    return this.ppagData[this.getPPAGChaveColecao()] || [];
                },
                getCampoMunicipioPPAG(item) {
                    const keys = Object.keys(item || {});
                    const found = keys.find(k => String(k).toUpperCase().includes('MUNIC'));
                    return found || 'MUNICIPIO';
                },

                getValorNivelPPAG(item) {
                    if (this.ppagNivel === 'MUNICIPIO') return item[this.getCampoMunicipioPPAG(item)] || '';
                    if (this.ppagNivel === 'CIA_PM') return item['CIA_PM'] || '';
                    return item['PELOTAO'] || item['PELOT?O'] || '';
                },

                processarPPAG() {

                    const mesesAtivos = this.getPPAGMesesAtivos();
                    const busca = (this.ppagBusca || '').toUpperCase();

                    const consolidar = (nivel) => {
                        const chave = nivel === 'MUNICIPIO' ? 'municipios' : (nivel === 'CIA_PM' ? 'cias' : 'pelotoes');
                        let ops = this.ppagData[chave] || [];
                        if (this.ppagOperacaoFiltro !== 'TODAS') ops = ops.filter(op => op.id === this.ppagOperacaoFiltro);

                        const mapa = {};
                        let total = 0;
                        ops.forEach(op => {
                            (op.dados || []).forEach(item => {
                                let nome;
                                if (nivel === 'MUNICIPIO') nome = item[this.getCampoMunicipioPPAG(item)] || '';
                                else if (nivel === 'CIA_PM') nome = item['CIA_PM'] || '';
                                else nome = item['PELOTAO'] || item['PELOT?O'] || '';

                                if (!nome) return;
                                if (busca && !String(nome).toUpperCase().includes(busca)) return;

                                if (!mapa[nome]) {
                                    mapa[nome] = { nome, totalCalculado: 0 };
                                    mesesAtivos.forEach(m => mapa[nome][m] = 0);
                                }

                                mesesAtivos.forEach(m => {
                                    const valor = parseFloat(item[m]) || 0;
                                    mapa[nome][m] += valor;
                                    mapa[nome].totalCalculado += valor;
                                    total += valor;
                                });
                            });
                        });

                        return { lista: Object.values(mapa), total };
                    };

                    const mun = consolidar('MUNICIPIO');
                    const pel = consolidar('PELOTAO');
                    const cia = consolidar('CIA_PM');
                    const atual = consolidar(this.ppagNivel);

                    this.ppagTotais = { MUNICIPIO: mun.total, PELOTAO: pel.total, CIA_PM: cia.total };
                    this.ppagTabela = atual.lista;
                    this.ppagTotalAtual = atual.total;
                },

                mudarNivelPPAG(nivel) {
                    this.ppagNivel = nivel;
                    this.ppagOperacaoFiltro = 'TODAS';
                    this.processarPPAG();
                },

                getValorPLR(unidadeId) {
                    const mapaAtual = this.dadosPLR_Processed[this.currentMeta];
                    if (!mapaAtual) return 0;

                    const idNormalizado = this.normalizarId(unidadeId);
                    let dados = mapaAtual[idNormalizado] || mapaAtual[String(unidadeId)] || mapaAtual[idNormalizado.replace('.', '')];

                    if (!dados) return 0;
                    return this.mesesSelecionados.reduce((acc, mes) => acc + (dados[mes] || dados[mes.toUpperCase()] || 0), 0);
                },
                
                temPLR() {
                    const mapaAtual = this.dadosPLR_Processed[this.currentMeta];
                    return !!mapaAtual && Object.keys(mapaAtual).length > 0;
                },

                calcularTaxa(valor, populacao) {
                    let val = parseFloat(valor) || 0;
                    let pop = parseFloat(populacao) || 0;
                    if (pop === 0) return 0;
                    return (val / pop) * 100000;
                },

                // --- AGREGADORES ---
                getTotaisBPM() {
                    let totalAbsoluto = 0, totalPop = 0, totalMetaPLR = 0;
                    let unidades = this.dadosBase[this.currentMeta] || [];
                    
                    unidades.forEach(unidade => {
                        const totaisUnidade = this.getTotaisUnidade(unidade);
                        totalAbsoluto += totaisUnidade.absoluto;
                        totalPop += totaisUnidade.populacao;
                        if (this.temMeta()) totalMetaPLR += this.getMetaUnidade(unidade.id);
                    });
                    
                    return { 
                        absoluto: Math.round(totalAbsoluto * 100) / 100, 
                        populacao: totalPop, 
                        metaPLR: Math.round(totalMetaPLR * 100) / 100, 
                        taxa: this.calcularTaxa(totalAbsoluto, totalPop) 
                    };
                },

                getTotaisPelotao(pelotao) {
                    let totalAbsoluto = 0, totalPop = 0;
                    pelotao.setores.forEach(set => { 
                        totalAbsoluto += this.getValorAcumulado(set.dados); 
                        totalPop += parseFloat(set.dados.pop) || 0; 
                    });
                    return { absoluto: Math.round(totalAbsoluto * 100) / 100, populacao: totalPop, taxa: this.calcularTaxa(totalAbsoluto, totalPop) };
                },

                getTotaisUnidade(unidade) {
                    let totalAbsoluto = 0, totalPop = 0;
                    unidade.pelotoes.forEach(pel => { 
                        pel.setores.forEach(set => { 
                            totalAbsoluto += this.getValorAcumulado(set.dados); 
                            totalPop += parseFloat(set.dados.pop) || 0; 
                        }); 
                    });
                    return { absoluto: Math.round(totalAbsoluto * 100) / 100, populacao: totalPop, taxa: this.calcularTaxa(totalAbsoluto, totalPop) };
                },

                getTotaisGerais() {
                    let totalAbsoluto = 0, totalPop = 0;
                    this.dadosFiltrados.forEach(unidade => { 
                        const totais = this.getTotaisUnidade(unidade); 
                        totalAbsoluto += totais.absoluto; 
                        totalPop += totais.populacao; 
                    });
                    return { absoluto: Math.round(totalAbsoluto * 100) / 100, populacao: totalPop, taxa: this.calcularTaxa(totalAbsoluto, totalPop) };
                },

                get dadosFiltrados() {
                    if (this.currentMeta === 'meta_ppag') return [];
                    let dados = this.dadosBase[this.currentMeta] || [];
                    if (this.filtroUnidade !== 'todas') dados = dados.filter(u => u.unidade === this.filtroUnidade);
                    return dados;
                },
                getUniqueUnidades() {
                    if (this.currentMeta === 'meta_ppag') return [];
                    const dados = this.dadosBase[this.currentMeta] || [];
                    return [...new Set(dados.map(item => item.unidade))];
                },
                getMetasPorGrupo(grupoId) { return this.metasDisponiveis.filter(meta => meta.grupo === grupoId); },
                getNomeMetaAtual() { const m = this.metasDisponiveis.find(m => m.id === this.currentMeta); return m ? m.nome : 'Selecione'; },
                mudarMeta(meta) {
                    this.currentMeta = meta.id;
                    this.filtroUnidade = 'todas';
                    if (meta.id === 'meta_ppag') {
                        this.ppagNivel = 'PELOTAO';
                        this.ppagOperacaoFiltro = 'TODAS';
                        this.ppagBusca = '';
                    }
                    if (meta.arquivo) {
                        this.carregarDadosLocalmente(meta.id);
                    }
                    if (meta.id === 'meta_ppag' && (this.ppagData.pelotoes || []).length > 0) {
                        this.processarPPAG();
                    }
                },
                toggleUnidade(id) { if(this.expandedUnidades.includes(id)) this.expandedUnidades=this.expandedUnidades.filter(u=>u!==id); else this.expandedUnidades.push(id); },
                togglePelotao(id) { if(this.expandedPelotoes.includes(id)) this.expandedPelotoes=this.expandedPelotoes.filter(p=>p!==id); else this.expandedPelotoes.push(id); },
                formatNumber(num) { if(num===undefined||num===null||isNaN(num)) return '0'; if(Number.isInteger(num)) return num.toLocaleString('pt-BR'); return num.toLocaleString('pt-BR', {minimumFractionDigits:1, maximumFractionDigits:2}); }
            }));
        });
    </script>
</head>

<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden" x-data="appData">

    <!-- HEADER -->
    <header class="bg-pmmg-black text-white shadow-lg z-30 flex-none border-b-4 border-pmmg-gold">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-pmmg-gold rounded flex items-center justify-center text-pmmg-black shadow-inner overflow-hidden">
                    <img src="./imagens/Icones_logo_19bpm/android-chrome-192x192.png" alt="Logo 19?? BPM" class="w-8 h-8 object-contain">
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wider leading-tight">METAS 19Âº bpm - 2026</h1>
                    <p class="text-[10px] text-pmmg-gold font-semibold uppercase tracking-widest">19Âº BPM - PMMG</p>
                </div>
            </div>
        </div>
    </header>

    <!-- ÃREA PRINCIPAL -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR -->
        <nav class="bg-white md:w-72 flex-none border-r border-gray-200 flex md:flex-col absolute md:static top-0 w-full z-20 md:z-auto shadow-md md:shadow-none overflow-x-auto">
            <div class="p-4 md:border-b border-gray-100 hidden md:block"><span class="text-xs font-bold text-gray-400 uppercase">Tipos de Metas</span></div>

            <div class="hidden md:block px-4 pt-4 pb-1 text-[11px] font-bold uppercase tracking-wide text-gray-400">Metas de Resultado do GDO</div>
            <template x-for="meta in getMetasPorGrupo('resultado_gdo')" :key="meta.id">
                <button @click="mudarMeta(meta)" class="flex items-center gap-3 px-6 py-3 text-sm font-medium transition-all border-l-4 hover:bg-gray-50" :class="currentMeta === meta.id ? 'border-pmmg-red text-pmmg-red bg-red-50' : 'border-transparent text-gray-600 hover:text-pmmg-black'">
                    <i :class="meta.icon" class="text-lg opacity-80"></i><span x-text="meta.nome"></span>
                </button>
            </template>

            <div class="hidden md:block px-4 pt-4 pb-1 text-[11px] font-bold uppercase tracking-wide text-gray-400">Metas do Plano de A&ccedil;&atilde;o</div>
            <template x-for="meta in getMetasPorGrupo('plano_acao')" :key="meta.id">
                <button @click="mudarMeta(meta)" class="flex items-center gap-3 px-6 py-3 text-sm font-medium transition-all border-l-4 hover:bg-gray-50" :class="currentMeta === meta.id ? 'border-pmmg-red text-pmmg-red bg-red-50' : 'border-transparent text-gray-600 hover:text-pmmg-black'">
                    <i :class="meta.icon" class="text-lg opacity-80"></i><span x-text="meta.nome"></span>
                </button>
            </template>

            <div class="hidden md:block px-4 pt-4 pb-1 text-[11px] font-bold uppercase tracking-wide text-gray-400">Metas do Plano de Proximidade</div>
            <template x-for="meta in getMetasPorGrupo('plano_proximidade')" :key="meta.id">
                <button @click="mudarMeta(meta)" class="flex items-center gap-3 px-6 py-3 text-sm font-medium transition-all border-l-4 hover:bg-gray-50" :class="currentMeta === meta.id ? 'border-pmmg-red text-pmmg-red bg-red-50' : 'border-transparent text-gray-600 hover:text-pmmg-black'">
                    <i :class="meta.icon" class="text-lg opacity-80"></i><span x-text="meta.nome"></span>
                </button>
            </template>

            <div class="md:hidden p-2 flex gap-2 overflow-x-auto">
                <template x-for="meta in metasDisponiveis" :key="`m-${meta.id}`">
                    <button @click="mudarMeta(meta)" class="flex items-center gap-2 px-3 py-2 text-xs font-semibold rounded border whitespace-nowrap" :class="currentMeta === meta.id ? 'bg-pmmg-black text-pmmg-gold border-pmmg-black' : 'bg-white text-gray-600 border-gray-300'">
                        <i :class="meta.icon"></i><span x-text="meta.nome"></span>
                    </button>
                </template>
            </div>
        </nav>

        <!-- CONTEÃšDO -->
        <main class="flex-1 overflow-y-auto bg-gray-100 p-4 pt-20 md:pt-4 relative w-full">
            <div class="max-w-6xl mx-auto space-y-6">
                
                <!-- AVISO DE ERRO VISUAL -->
                <div x-show="erroCarregamento" x-cloak class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-md mb-4">
                    <p class="font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>AtenÃ§Ã£o:</p>
                    <p x-text="erroCarregamento"></p>
                </div>
                <div x-show="currentMeta === 'meta_ppag' && !loading" class="bg-white rounded-lg shadow-sm border-l-4 border-pmmg-gold p-4 md:p-6 space-y-5">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <div class="flex items-center gap-2">
                                <h2 class="text-xl font-bold text-gray-800">Metas PPAG</h2>
                                <button @click="ppagInfoOpen = true" class="w-7 h-7 rounded-full bg-pmmg-gold text-pmmg-black text-xs font-bold shadow hover:brightness-95" title="Guia das naturezas">?</button>
                            </div>
                            <p class="text-sm text-gray-500">Vis&atilde;o consolidada por n&iacute;vel operacional</p>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-center min-w-[180px]">
                            <span class="text-[10px] text-blue-500 uppercase font-bold tracking-wide" x-text="getMetaLabel()"></span>
                            <span class="block text-2xl font-bold text-blue-600" x-text="formatNumber(getMetaBPM())"></span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="p-3 bg-gray-50 rounded border"><p class="text-xs text-gray-500 uppercase font-semibold">Munic&iacute;pios</p><p class="text-2xl font-bold text-gray-800" x-text="formatNumber(ppagTotais.MUNICIPIO)"></p></div>
                        <div class="p-3 bg-gray-50 rounded border"><p class="text-xs text-gray-500 uppercase font-semibold">Pelot&otilde;es</p><p class="text-2xl font-bold text-gray-800" x-text="formatNumber(ppagTotais.PELOTAO)"></p></div>
                        <div class="p-3 bg-gray-50 rounded border"><p class="text-xs text-gray-500 uppercase font-semibold">Cias PM</p><p class="text-2xl font-bold text-gray-800" x-text="formatNumber(ppagTotais.CIA_PM)"></p></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="md:col-span-2 flex flex-wrap gap-2">
                            <button @click="mudarNivelPPAG('MUNICIPIO')" class="px-3 py-2 text-xs font-semibold rounded border" :class="ppagNivel === 'MUNICIPIO' ? 'bg-pmmg-black text-pmmg-gold border-pmmg-black' : 'bg-white text-gray-600 border-gray-300'">Munic&iacute;pios</button>
                            <button @click="mudarNivelPPAG('PELOTAO')" class="px-3 py-2 text-xs font-semibold rounded border" :class="ppagNivel === 'PELOTAO' ? 'bg-pmmg-black text-pmmg-gold border-pmmg-black' : 'bg-white text-gray-600 border-gray-300'">Pelot&otilde;es</button>
                            <button @click="mudarNivelPPAG('CIA_PM')" class="px-3 py-2 text-xs font-semibold rounded border" :class="ppagNivel === 'CIA_PM' ? 'bg-pmmg-black text-pmmg-gold border-pmmg-black' : 'bg-white text-gray-600 border-gray-300'">Cias PM</button>
                        </div>
                        <input x-model="ppagBusca" @input="processarPPAG()" type="text" placeholder="Buscar..." class="bg-gray-50 border border-gray-300 text-sm rounded p-2.5 outline-none">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <select x-model="ppagOperacaoFiltro" @change="processarPPAG()" class="bg-gray-50 border border-gray-300 text-sm rounded p-2.5 outline-none">
                            <option value="TODAS">Todas Opera&ccedil;&otilde;es</option>
                            <template x-for="op in getPPAGOperacoesDisponiveis()" :key="op.id">
                                <option :value="op.id" x-text="op.nome"></option>
                            </template>
                        </select>
                        <div class="p-2.5 bg-blue-50 border border-blue-100 rounded text-sm text-blue-800 font-semibold">
                            Per&iacute;odo: <span x-text="getLabelMeses()"></span>
                        </div>
                    </div>

                    <div class="overflow-x-auto rounded-lg border border-gray-100">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3">N&iacute;vel</th>
                                    <template x-for="mes in getPPAGMesesAtivos()" :key="mes"><th class="px-4 py-3 text-center" x-text="mes"></th></template>
                                    <th class="px-4 py-3 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="linha in ppagTabela" :key="linha.nome">
                                    <tr class="border-b hover:bg-gray-50 transition">
                                        <td class="px-4 py-3 font-medium text-gray-900" x-text="linha.nome"></td>
                                        <template x-for="mes in getPPAGMesesAtivos()" :key="`${linha.nome}-${mes}`">
                                            <td class="px-4 py-3 text-center" x-text="formatNumber(linha[mes] || 0)"></td>
                                        </template>
                                        <td class="px-4 py-3 text-center font-bold text-gray-800" x-text="formatNumber(linha.totalCalculado || 0)"></td>
                                    </tr>
                                </template>
                                <tr x-show="ppagTabela.length === 0"><td class="px-4 py-3 text-center text-gray-400" :colspan="getPPAGMesesAtivos().length + 2">Sem dados para os filtros selecionados.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div x-show="ppagInfoOpen" x-cloak class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm" @click.self="ppagInfoOpen = false">
                    <div class="w-full max-w-3xl max-h-[85vh] overflow-y-auto bg-white rounded-xl shadow-2xl border-t-4 border-pmmg-gold p-5 md:p-6">
                        <div class="flex items-start justify-between gap-3 mb-3">
                            <h3 class="text-lg font-bold text-gray-800">Guia de Naturezas e Utiliza&ccedil;&atilde;o</h3>
                            <button @click="ppagInfoOpen = false" class="w-8 h-8 rounded-full border text-gray-600 hover:bg-gray-100">&times;</button>
                        </div>

                        <p class="text-xs text-gray-500 italic mb-4">* Somente equipes do portf&oacute;lio espec&iacute;fico podem gerar estas naturezas.</p>

                        <details class="border-b py-3">
                            <summary class="cursor-pointer font-semibold text-gray-800">Y07012 - Prev. Viol&ecirc;ncia Dom&eacute;stica (RpPM)</summary>
                            <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-pmmg-gold text-sm text-gray-700">(ESPEC&Iacute;FICA) RpPM: Atividade de pol&iacute;cia ostensiva realizada pelas equipes de Preven&ccedil;&atilde;o &agrave; Viol&ecirc;ncia Dom&eacute;stica, para demandas n&atilde;o atendidas pelo policiamento ordin&aacute;rio.</div>
                        </details>

                        <details class="border-b py-3">
                            <summary class="cursor-pointer font-semibold text-gray-800">Y15001 - Patrulha Escolar / Drogas</summary>
                            <div class="mt-2 p-3 bg-gray-50 border-l-4 border-gray-300 text-sm text-gray-700">Visitas a escolas e estabelecimentos de ensino com foco preventivo e presen&ccedil;a ostensiva.</div>
                        </details>

                        <details class="border-b py-3">
                            <summary class="cursor-pointer font-semibold text-gray-800">Y15010 e Y07014 - Zona Rural</summary>
                            <div class="mt-2 p-3 bg-gray-50 border-l-4 border-gray-300 text-sm text-gray-700">
                                <p><strong>(ESPEC&Iacute;FICA) Y15010:</strong> Presen&ccedil;a real para fortalecer intera&ccedil;&atilde;o com a popula&ccedil;&atilde;o rural e prevenir infra&ccedil;&otilde;es.</p>
                                <p class="mt-2"><strong>Y07014:</strong> Contato e confian&ccedil;a junto ao campo e agroneg&oacute;cio, com miss&atilde;o distinta do policiamento ambiental.</p>
                            </div>
                        </details>

                        <details class="border-b py-3">
                            <summary class="cursor-pointer font-semibold text-gray-800">Y15020 - A&ccedil;&atilde;o em &Aacute;rea de Risco (GEPAR)</summary>
                            <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-pmmg-gold text-sm text-gray-700">(ESPEC&Iacute;FICA) GEPAR: A&ccedil;&otilde;es preventivas em &aacute;reas urbanas de risco, exclusivas do Grupo Especializado de Patrulhamento em &Aacute;reas de Risco.</div>
                        </details>

                        <details class="py-3">
                            <summary class="cursor-pointer font-semibold text-gray-800">Y15052 - Opera&ccedil;&atilde;o BSC</summary>
                            <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-pmmg-gold text-sm text-gray-700">(ESPEC&Iacute;FICA) BSC: Atividades da Base de Seguran&ccedil;a Comunit&aacute;ria, com preenchimento dos formul&aacute;rios previstos em norma.</div>
                        </details>
                    </div>
                </div>

                <!-- Painel Resumo e Filtros -->

                <div x-show="currentMeta !== 'meta_ppag'" class="bg-white rounded-lg shadow-sm border-l-4 border-pmmg-gold p-4 md:p-6">
                    
                    <!-- LINHA 1: TÃ­tulo e Cards de Resumo BPM -->
                    <div class="flex flex-col xl:flex-row justify-between xl:items-center gap-6 mb-6">
                        
                        <div class="flex-1 flex flex-col md:flex-row gap-6 md:items-center">
                            <!-- TÃ­tulo -->
                            <div class="shrink-0">
                                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><span x-text="getNomeMetaAtual()"></span><span class="text-xs bg-pmmg-black text-pmmg-gold px-2 py-0.5 rounded uppercase">2026</span></h2>
                                <p class="text-sm text-gray-500 mt-1">VisÃ£o EstratÃ©gica</p>
                            </div>

                            <!-- CARD DE RESUMO 19Âº BPM -->
                                                        <div class="flex-1 bg-gray-50 border border-gray-200 rounded-lg p-2 flex items-center justify-around shadow-sm min-w-[300px]">
                                <template x-if="currentMeta !== 'meta_irtd'">
                                    <div class="text-center px-2">
                                        <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wide">19? BPM (Total)</span>
                                        <span class="block text-xl font-bold text-gray-800" x-text="formatNumber(getTotaisBPM().absoluto)"></span>
                                    </div>
                                </template>
                                <template x-if="currentMeta !== 'meta_irtd'"><div class="h-10 w-px bg-gray-300"></div></template>
                                <div class="text-center px-2">
                                    <span class="text-[10px] text-blue-500 uppercase font-bold tracking-wide" x-text="getMetaLabel()"></span>
                                    <span class="block text-xl font-bold text-blue-600" x-text="temMeta() ? formatNumber(getMetaBPM()) : '-'"></span>
                                </div>
                                <template x-if="currentMeta !== 'meta_irtd'"><div class="h-10 w-px bg-gray-300"></div></template>
                                <template x-if="currentMeta !== 'meta_irtd'">
                                    <div class="text-center px-2">
                                        <span class="text-[10px] text-pmmg-red uppercase font-bold tracking-wide">Taxa (100k)</span>
                                        <span class="block text-xl font-bold text-pmmg-red" x-text="formatNumber(getTotaisBPM().taxa)"></span>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- Filtros (Lado Direito) -->
                        <div class="flex flex-wrap gap-2 items-center shrink-0">
                            <!-- Dropdown Meses -->
                            <div class="relative" x-data="{ open: false }" @click.outside="open = false">
                                <button @click="open = !open" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-pmmg-gold focus:border-pmmg-gold p-2.5 flex items-center justify-between min-w-[180px]"><span class="truncate mr-2" x-text="getLabelMeses()"></span><i class="fa-solid fa-chevron-down text-xs text-gray-500"></i></button>
                                <div x-show="open" class="absolute top-full right-0 mt-1 w-64 bg-white border border-gray-200 rounded shadow-lg z-50 p-3" x-transition>
                                    <div class="flex justify-between mb-2 pb-2 border-b border-gray-100 items-center"><div class="flex gap-3"><button @click="selecionarTodosMeses()" class="text-xs text-pmmg-gold font-bold hover:underline">Todos</button><button @click="limparMeses()" class="text-xs text-gray-400 hover:text-red-500 hover:underline">Limpar</button></div><span class="text-xs text-gray-400">Acumulado</span></div>
                                    <div class="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto"><template x-for="mes in mesesLista" :key="mes.id"><label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-1 rounded"><input type="checkbox" :value="mes.id" :checked="mesesSelecionados.includes(mes.id)" @change="toggleMes(mes.id)" class="form-checkbox h-4 w-4 text-pmmg-gold rounded focus:ring-pmmg-gold"><span class="text-xs text-gray-700" x-text="mes.label"></span></label></template></div>
                                </div>
                            </div>
                            <!-- Select Unidade -->
                            <select x-model="filtroUnidade" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded focus:ring-pmmg-gold focus:border-pmmg-gold block p-2.5 outline-none"><option value="todas">Todas Unidades</option><template x-for="unidade in getUniqueUnidades()" :key="unidade"><option :value="unidade" x-text="unidade"></option></template></select>
                        </div>
                    </div>

                    <!-- LINHA 2: Resumo do Filtro -->
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pt-6 border-t border-gray-100">
                        <template x-if="currentMeta !== 'meta_irtd'"><div class="p-3 bg-gray-50 rounded border border-gray-100 hover:shadow-md transition"><p class="text-xs text-gray-500 uppercase font-semibold">Total (Filtro)</p><p class="text-2xl font-bold text-pmmg-black mt-1" x-text="formatNumber(getTotaisGerais().absoluto)"></p></div></template>
                        <template x-if="currentMeta !== 'meta_irtd'"><div class="p-3 bg-gray-50 rounded border border-gray-100 hover:shadow-md transition"><p class="text-xs text-gray-500 uppercase font-semibold">Popula??o Coberta</p><p class="text-2xl font-bold text-pmmg-black mt-1" x-text="formatNumber(getTotaisGerais().populacao)"></p></div></template>
                        <template x-if="currentMeta !== 'meta_irtd'"><div class="p-3 bg-red-50 rounded border border-red-100"><p class="text-xs text-pmmg-red uppercase font-semibold">Taxa Geral (100k)</p><div class="flex items-baseline gap-1 mt-1"><p class="text-2xl font-bold text-pmmg-red" x-text="formatNumber(getTotaisGerais().taxa)"></p><span class="text-[10px] text-red-400">/ 100 mil</span></div></div></template>
                        <div class="p-3 bg-blue-50 rounded border border-blue-100"><p class="text-xs text-blue-700 uppercase font-semibold">Per?odo</p><p class="text-sm font-bold text-blue-900 mt-2 truncate" x-text="getLabelMeses()"></p></div>
                    </div>
                </div>

                <!-- Loading -->
                <div x-show="loading" class="text-center py-8"><i class="fa-solid fa-spinner fa-spin text-3xl text-pmmg-gold"></i><p class="text-gray-500 mt-2 font-medium">Carregando...</p></div>
                
                <!-- Lista de Unidades -->
                <div x-show="!loading && currentMeta !== 'meta_ppag'" class="space-y-4">
                    <template x-for="unidade in dadosFiltrados" :key="unidade.id">
                        <div class="bg-white rounded-lg shadow-sm overflow-hidden border border-gray-200 transition hover:border-pmmg-gold">
                            <div class="bg-gray-800 px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" @click="toggleUnidade(unidade.id)">
                                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-pmmg-gold text-white flex items-center justify-center font-bold text-xs shadow-md">CIA</div><h3 class="font-bold text-white text-sm md:text-base tracking-wide" x-text="unidade.unidade"></h3></div>
                                <div class="flex items-center gap-4 text-right">
                                    <div class="flex flex-col md:flex-row gap-4 text-xs">
                                        <template x-if="currentMeta !== 'meta_irtd'"><div><span class="text-gray-400 uppercase text-[10px]">Total</span><span class="block text-white font-bold text-sm" x-text="formatNumber(getTotaisUnidade(unidade).absoluto)"></span></div></template>
                                        <template x-if="currentMeta !== 'meta_irtd'"><div class="border-l border-gray-600 pl-4"><span class="text-gray-400 uppercase text-[10px]">Taxa</span><span class="block text-pmmg-gold font-bold text-sm" x-text="formatNumber(getTotaisUnidade(unidade).taxa)"></span></div></template>
                                        <template x-if="temMeta()"><div :class="currentMeta === 'meta_irtd' ? '' : 'border-l border-gray-600 pl-4'"><span class="text-blue-300 uppercase text-[10px] font-bold" x-text="currentMeta === 'meta_irtd' ? 'Meta' : 'PLR (Meta)'"></span><span class="block text-blue-400 font-bold text-sm" x-text="formatNumber(getMetaUnidade(unidade.id))"></span></div></template>
                                    </div>
                                    <i class="fa-solid fa-chevron-down text-gray-400 transition-transform duration-300 ml-2" :class="expandedUnidades.includes(unidade.id) ? 'rotate-180' : ''"></i>
                                </div>
                            </div>
                            <!-- PelotÃµes -->
                            <div x-show="expandedUnidades.includes(unidade.id)" x-collapse class="bg-gray-50 border-t border-gray-200">
                                <template x-for="pelotao in unidade.pelotoes" :key="pelotao.id">
                                    <div class="border-b border-gray-200 last:border-0">
                                        <div class="px-4 py-2 bg-gray-100 flex justify-between items-center cursor-pointer hover:bg-gray-200 transition pl-8 md:pl-12 select-none" @click="togglePelotao(pelotao.id)">
                                            <div class="flex items-center gap-2"><i class="fa-solid fa-users text-pmmg-gold text-xs"></i><span class="font-semibold text-gray-700 text-sm" x-text="pelotao.nome"></span></div>
                                            <div class="flex items-center gap-4"><div class="hidden sm:flex gap-3 text-xs text-gray-500"><template x-if="currentMeta !== 'meta_irtd'"><div><span class="text-[9px] uppercase">Pop:</span><span class="font-bold" x-text="formatNumber(getTotaisPelotao(pelotao).populacao)"></span></div></template><template x-if="currentMeta !== 'meta_irtd'"><div><span class="text-[9px] uppercase">Total:</span><span class="font-bold text-gray-700" x-text="formatNumber(getTotaisPelotao(pelotao).absoluto)"></span></div></template><template x-if="currentMeta !== 'meta_irtd'"><div><span class="text-[9px] uppercase">Taxa:</span><span class="font-bold text-pmmg-red" x-text="formatNumber(getTotaisPelotao(pelotao).taxa)"></span></div></template><template x-if="currentMeta === 'meta_irtd'"><div><span class="text-[9px] uppercase">Meta:</span><span class="font-bold text-blue-600" x-text="formatNumber(getMetaIRTDPelotao(pelotao.id))"></span></div></template></div><i class="fa-solid fa-chevron-right text-xs text-gray-400 transition-transform duration-300" :class="expandedPelotoes.includes(pelotao.id) ? 'rotate-90' : ''"></i></div>
                                        </div>
                                        <!-- Setores -->
                                        <div x-show="expandedPelotoes.includes(pelotao.id)" x-collapse class="bg-white p-2 md:p-4">
                                            <div class="overflow-x-auto rounded-lg border border-gray-100">
                                                <table class="w-full text-sm text-left text-gray-500">
                                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-4 py-3 rounded-tl-lg">Setor / Local</th><template x-if="currentMeta !== 'meta_irtd'"><th class="px-4 py-3 text-center w-32">Populacao</th></template><template x-if="currentMeta !== 'meta_irtd'"><th class="px-4 py-3 text-center bg-pmmg-gold/10 text-pmmg-black w-32">Acumulado</th></template><template x-if="currentMeta === 'meta_irtd'"><th class="px-4 py-3 text-center bg-blue-50 text-blue-700 w-32">Meta</th></template><template x-if="currentMeta !== 'meta_irtd'"><th class="px-4 py-3 text-center bg-red-50 text-pmmg-red rounded-tr-lg w-32">Taxa (100k)</th></template></tr></thead>
                                                    <tbody>
                                                        <template x-for="setor in pelotao.setores" :key="setor.id">
                                                            <tr class="border-b hover:bg-gray-50 transition"><td class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap"><div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-pmmg-red"></div><span x-text="setor.local"></span></div></td><template x-if="currentMeta !== 'meta_irtd'"><td class="px-4 py-3 text-center text-gray-400"><span x-text="formatNumber(parseFloat(setor.dados.pop))"></span></td></template><template x-if="currentMeta !== 'meta_irtd'"><td class="px-4 py-3 text-center font-bold text-gray-800 bg-yellow-50/30"><span x-text="formatNumber(getValorAcumulado(setor.dados))"></span></td></template><template x-if="currentMeta === 'meta_irtd'"><td class="px-4 py-3 text-center font-bold text-blue-700 bg-blue-50/50"><span x-text="formatNumber(getMetaIRTDSetor(setor.id))"></span></td></template><template x-if="currentMeta !== 'meta_irtd'"><td class="px-4 py-3 text-center font-bold text-pmmg-red bg-red-50/50"><span x-text="formatNumber(calcularTaxa(getValorAcumulado(setor.dados), setor.dados.pop))"></span></td></template></tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="mt-10 mb-4 text-center text-xs text-gray-400 font-mono">&copy; 2026 PolÃ­cia Militar de Minas Gerais - Setor de InteligÃªncia</div>
        </main>
    </div>
</body>
</html>
